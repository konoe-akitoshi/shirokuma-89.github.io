---
layout: post
title:  "STM32でBLDCを回すんじゃい"
date:   2021-04-18
image:  021-030/029/top.jpg
tags:  [STM32, BLDC]
---

雨の日はどんなに短距離の移動でも絶対傘を使う派のしろくま＠胡瓜です。

最近モーター探しで色々と中国語のデーターシートとかサイトとかを目にすることが多いんですが全然意味わかんないです。翻訳もあんまり当てにならないので潔く諦めてます。中国語は「手纸」が手紙じゃないってことぐらいしか知らないです。頼むから英語表記してください。英語読めないけど。

## BLDCを回してみたい

前お話ししたように今使ってるPololuモーターが寿命に近づいています。3年前から正転逆転ぶんぶん回してたらそりゃ当然ですよね。

**ロボット：「モーター？俺のがギュインギュイン鳴ってるぜ？」**

…

…

…

というわけで~~どういうわけだよ~~、Pololu買い直すよりは新しいことにチャレンジしたいなーと思って脳内に浮かんだのがBLDCです。なんとなく名前の響きがかっこいい+なんか効率がいいらしいので買ってみました。

## BLDCとは

**ブラシレスDCモーターのことです。以上。**

というのも不親切なので簡単に説明を。自分もまだ全然理解できてないですが。

文字通り「ブラシがない」モーターのことです。「ブラシって何？」な人はごめんなさい、ここから先は全然意味わからないと思います。

一般的なDCモーター（以下区別するためにブラシ付きDCと呼びます。）は配線が2本あり、軸が回転するとブラシと整流子の働きで内部の電磁石の極性が入れ替わり回り続けます。いわゆる「コイルが回る」ってことですね。しかし、ブラシと整流子があることによって接触とか摩擦だとかどうたらこうたらロスが発生してしまうので、なんとかしてロスを無くせないかと頭いい人たちが考えた結果、**そもそもブラシをなくす**という結論になりました。これがブラシレスモーター（以下BLDC）です。

BLDCはブラシ付きDCに対して**磁石が回る**構造になっています。そのため、コイルに流れる電流を高速にON/OFFしたり逆向きにしたりして電磁石のN極とS極を**FETなどで電気的に制御**して回転させる構造になっています。つまり、**電池を繋ぐだけじゃ回らない**のです。

BLDCを制御するのは色々大変らしいのでブラシ付きDCでいうモータードライバにあたる**ESC**という部品を使って今回はNucleoで回すことにしました。

## 用意するもの

- Nucleo（なんでもいい）
- ESC
- BLDC
- 配線材料
- パソコン君
- やる気

ですかね。

## 配線

BLDCから生えている三本の線を対応するESCの線に半田付けします。そしてESCにバッテリーを接続して、さらにESCの入力ピンにNucleoのピン（今回はD9にしました）を接続して、NucleoとESCのGNDと+5Vを接続したら完成です。

![]({{site.baseurl}}/img/021-030/029/001.jpg)

こんな感じ~~←どんな感じ？~~ですね。

一通り回し終えた後にブログのこと思い出してとった写真なのでESCの絶縁カバーが剥がされてますが気にすることはありません。どうしても中身が見てみたくなったので脱がせました（変態）

## プログラム

これが曲者でPWMを突っ込めばDuty比で動かせるとかそういうやつじゃないんですよ。

![]({{site.baseurl}}/img/021-030/029/002.png)

Aの部分は20000msで固定（別に20000である必要はなく、一般的に20000が使われがちなだけで変えられます。）でBの部分を1000msから2000msの間で変化させることで速度を変更します。Bを1000msで0%、1500msで50%、2000msで100%って感じですね。

感のいい人はわかったかもしれませんが、サーボモーターの動かし方と信号自体は同じなんです。僕は気づかなかったのでググってから気づきました。というわけでServoライブラリを流用していきたいと思います。Servoライブラリを使わないバージョンもいつか作ってみたいなぁ。

<script src="https://gist.github.com/shirokuma-89/3d9f99d8fe55d7fc3a602996475373c8.js"></script>

プログラムです。`setup()`で色々やってるのは、今回使ったドローン用のESCに安全機能がついてるためです。ドローン経験者の人はわかるのかもしれませんが、一回スロットルをFullにしてからLowにするという動作をしないと操作できないようになってるらしいです。僕はドローンやったことがないので実際のドローンに関してはわかりません。

あと、プログラムを走らせる前にモーターをなんらかの形で固定しておいてください。単純に危ないからです。

## いざ！

<center><blockquote class="twitter-tweet" data-theme="dark"><p lang="ja" dir="ltr">Nucleoでブラシレスモーター制御！！ <a href="https://t.co/Noe0cpTH8b">pic.twitter.com/Noe0cpTH8b</a></p>&mdash; しろくま🥒胡瓜 Root41 (@robokichi41) <a href="https://twitter.com/robokichi41/status/1382264929881755648?ref_src=twsrc%5Etfw">April 14, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></center>

いい感じですね💪　エンジンみたいな音がして旅客機LOVEの僕には胸アツです。

## まとめ

- BLDCは制御しないと回らない
- パルスの幅を変えることでスピード制御できる
- ライブラリを活用しよう
- わからなかったらググればなんとかなる

といった感じです。ではまたね。

（なんとかしてコメント欄つけたいなぁ。）